<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Climb CAT 그래프</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 점 위에 이름을 붙이기 위한 플러그인 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 10px;
      padding: 0;
      max-width: 100%;
    }

    #chartContainer {
      width: 100%;
      height: 50vh;   /* 화면 높이의 절반 정도 */
      max-height: 600px;
      min-height: 300px;
    }

    .controls {
      margin-top: 12px;
    }

    .row {
      margin-bottom: 8px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-row label {
      width: 120px;
      flex-shrink: 0;
    }

    .slider-row input[type="range"] {
      flex-grow: 1;
    }

    .value-label {
      width: 90px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    #name {
      padding: 6px 10px;
      max-width: 200px;
    }

    button {
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 5px;
    }

    #info {
      margin-top: 15px;
      font-size: 0.9rem;
      white-space: pre-line;
    }
  </style>
</head>

<body>
  <h2>CAT Threshold + 업힐 포인트 표시</h2>

  <div id="chartContainer">
    <canvas id="catChart"></canvas>
  </div>

  <div class="controls">
    <h3>업힐 추가</h3>

    <div class="row">
      <label for="name">이름 (옵션)</label>
      <input id="name" type="text" placeholder="예: 살둔재" />
    </div>

    <div class="row slider-row">
      <label for="distanceRange">거리 (km)</label>
      <input id="distanceRange" type="range" min="1" max="20" step="0.1" value="3" />
      <span class="value-label"><span id="distanceValue">3</span> km</span>
    </div>

    <div class="row slider-row">
      <label for="gradientRange">평균 경사 (%)</label>
      <input id="gradientRange" type="range" min="4" max="20" step="0.1" value="7.5" />
      <span class="value-label"><span id="gradientValue">7.5</span> %</span>
    </div>

    <button id="addClimbBtn">그래프에 추가</button>
  </div>

  <div id="info"></div>

  <script>
    const MIN_DIST = 1000;
    const MAX_DIST = 20000;
    const MIN_GRAD = 4;
    const MAX_GRAD = 20;

    const catDefs = [
      { label: "CAT4 (D = 8,000)",  D: 8000,  color: "rgba(255,165,0,1)" },
      { label: "CAT3 (D = 16,000)", D: 16000, color: "rgba(54,162,235,1)" },
      { label: "CAT2 (D = 32,000)", D: 32000, color: "rgba(75,192,192,1)" },
      { label: "CAT1 (D = 64,000)", D: 64000, color: "rgba(255,205,86,1)" },
      { label: "HC   (D = 80,000)", D: 80000, color: "rgba(153,102,255,1)" }
    ];

    function createCatDataset(def) {
      const data = [];
      for (let x = MIN_DIST; x <= MAX_DIST; x += 100) {
        const y = def.D / x;
        if (y >= MIN_GRAD && y <= MAX_GRAD) {
          data.push({ x, y });
        }
      }
      return {
        label: def.label,
        data,
        borderColor: def.color,
        backgroundColor: def.color,
        pointRadius: 0,
        borderWidth: 2,
        showLine: true,
        fill: false,
        type: "line"
      };
    }

    const climbsDataset = {
      label: "업힐 포인트",
      data: [],                // {x, y, name}
      backgroundColor: "rgba(220,20,60,1)",
      pointRadius: 6,
      showLine: false,
      type: "scatter"
    };

    const ctx = document.getElementById("catChart").getContext("2d");

    // datalabels 플러그인 등록
    Chart.register(ChartDataLabels);

    const datasets = catDefs.map(createCatDataset);
    datasets.push(climbsDataset);

    const catChart = new Chart(ctx, {
      type: "scatter",
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: "top" },
          datalabels: {
            // 업힐 포인트에만 라벨 표시
            display: (ctx) => ctx.dataset === climbsDataset,
            align: "top",
            anchor: "end",
            offset: 4,
            font: {
              size: 10,
              weight: "600"
            },
            formatter: (value, ctx) => {
              return value.name || "";
            }
          },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const d = ctx.raw;
                if (!d) return "";
                const dist = d.x.toFixed(0);
                const grad = d.y.toFixed(1);
                if (d.name) {
                  return `${d.name}: ${dist} m, ${grad} %`;
                }
                return `거리: ${dist} m, 경사: ${grad} %`;
              }
            }
          }
        },
        scales: {
          x: {
            type: "linear",
            min: MIN_DIST,
            max: MAX_DIST,
            title: { display: true, text: "Distance (m)" }
          },
          y: {
            min: MIN_GRAD,
            max: MAX_GRAD,
            title: { display: true, text: "Gradient (%)" }
          }
        }
      }
    });

    function classifyCAT(D) {
      if (D >= 80000) return "HC";
      if (D >= 64000) return "CAT1";
      if (D >= 32000) return "CAT2";
      if (D >= 16000) return "CAT3";
      if (D >= 8000)  return "CAT4";
      return "CAT 미만";
    }

    // 슬라이더 값 표시 업데이트
    const distanceRange = document.getElementById("distanceRange");
    const gradientRange = document.getElementById("gradientRange");
    const distanceValue = document.getElementById("distanceValue");
    const gradientValue = document.getElementById("gradientValue");

    distanceRange.addEventListener("input", () => {
      distanceValue.textContent = distanceRange.value;
    });

    gradientRange.addEventListener("input", () => {
      gradientValue.textContent = Number(gradientRange.value).toFixed(1);
    });

    // 업힐 추가 버튼
    document.getElementById("addClimbBtn").addEventListener("click", () => {
      const distance = Number(distanceRange.value);
      const gradient = Number(gradientRange.value);
      const name = (document.getElementById("name").value.trim() || `Climb ${climbsDataset.data.length + 1}`);

      const D = distance * 1000 * gradient;
      const logValue = Math.log2(D / 8000);
      const cat = classifyCAT(D);

      // 여러 개 계속 추가 가능
      climbsDataset.data.push({ x: distance * 1000, y: gradient, name });
      catChart.update();

      const line =
        `${name} → 거리: ${distance} km, ` +
        `경사: ${gradient.toFixed(1)} %, score = ${D.toFixed(0)}, ` +
        `5 - LOG(score/8000,2) = ${5 - logValue.toFixed(2)}, CAT = ${cat}`;

      const infoDiv = document.getElementById("info");
      infoDiv.textContent = (infoDiv.textContent ? infoDiv.textContent + "\n" : "") + line;

      // 이름 입력칸은 비워두고, 슬라이더 값은 유지
      document.getElementById("name").value = "";
    });
  </script>
</body>
</html>