<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Climb CAT ê·¸ë˜í”„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ì  ìœ„ì— ì´ë¦„ì„ ë¶™ì´ê¸° ìœ„í•œ í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    :root {
      --bg: #f9fafb;
      --fg: #111827;
      --subtle-bg: #f3f4f6;
      --border: #e5e7eb;
      --accent: #3b82f6;
      --accent-contrast: #f9fafb;
      --muted: #6b7280;
      --input-bg: #ffffff;
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --fg: #e5e7eb;
      --subtle-bg: #0b1120;
      --border: #1f2937;
      --accent: #3b82f6;
      --accent-contrast: #f9fafb;
      --muted: #9ca3af;
      --input-bg: #020617;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      max-width: 100%;
      background-color: var(--bg);
      color: var(--fg);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    #chartContainer {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      height: min(60vh, 480px);
      min-height: 260px;
      background: var(--subtle-bg);
      border-radius: 10px;
      padding: 8px;
    }

    .controls {
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      background-color: var(--subtle-bg);
      border: 1px solid var(--border);
    }

    h3 {
      margin: 0 0 8px 0;
      font-size: 1.05rem;
    }

    .row {
      margin-bottom: 8px;
    }

    .row label {
      display: inline-block;
      margin-bottom: 4px;
    }

    #name {
      width: 100%;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--fg);
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-row label {
      width: 120px;
      flex-shrink: 0;
    }

    .slider-row input[type="range"] {
      flex-grow: 1;
    }

    .value-label {
      width: 90px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    button {
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 5px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background-color: var(--accent);
      color: var(--accent-contrast);
      font-size: 0.9rem;
    }

    button:hover {
      opacity: 0.95;
    }

    .theme-toggle {
      padding: 6px 12px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: var(--subtle-bg);
      color: var(--fg);
    }

    .theme-toggle:hover {
      border-color: var(--accent);
    }

    #info {
      margin-top: 15px;
      font-size: 0.9rem;
      white-space: pre-line;
      color: var(--muted);
    }

    /* ëª¨ë°”ì¼ í™”ë©´ ìµœì í™” */
    @media (max-width: 640px) {
      body {
        padding: 10px;
      }

      .slider-row {
        flex-direction: column;
        align-items: stretch;
      }

      .slider-row label {
        width: 100%;
      }

      .value-label {
        width: 100%;
        text-align: left;
      }

      .top-bar {
        align-items: flex-start;
      }

      h2 {
        font-size: 1.1rem;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top-bar">
      <h2>CAT Threshold + ì—…í í¬ì¸íŠ¸ í‘œì‹œ</h2>
      <button id="themeToggle" class="theme-toggle">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
    </div>

    <div id="chartContainer">
      <canvas id="catChart"></canvas>
    </div>

    <div class="controls">
      <h3>ì—…í ì¶”ê°€</h3>

      <div class="row">
        <label for="name">ì´ë¦„ (ì˜µì…˜)</label>
        <input id="name" type="text" placeholder="ì˜ˆ: ì‚´ë‘”ì¬" />
      </div>

      <div class="row slider-row">
        <label for="distanceRange">ê±°ë¦¬ (km)</label>
        <input id="distanceRange" type="range" min="1" max="20" step="0.1" value="3" />
        <span class="value-label"><span id="distanceValue">3</span> km</span>
      </div>

      <div class="row slider-row">
        <label for="gradientRange">í‰ê·  ê²½ì‚¬ (%)</label>
        <input id="gradientRange" type="range" min="4" max="20" step="0.1" value="7.5" />
        <span class="value-label"><span id="gradientValue">7.5</span> %</span>
      </div>

      <button id="addClimbBtn">ê·¸ë˜í”„ì— ì¶”ê°€</button>
    </div>

    <div id="info"></div>
  </div>

  <script>
    // --- ë‹¤í¬ ëª¨ë“œ ì´ˆê¸°ê°’: ì‹œìŠ¤í…œ ì„¤ì • ë°˜ì˜ ---
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const root = document.documentElement;
    const themeToggleBtn = document.getElementById("themeToggle");

    function setTheme(isDark) {
      root.dataset.theme = isDark ? "dark" : "light";
      themeToggleBtn.textContent = isDark ? "â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ" : "ğŸŒ™ ë‹¤í¬ ëª¨ë“œ";
    }

    // ì´ˆê¸° ì ìš©
    setTheme(prefersDark);

    // í† ê¸€ ë²„íŠ¼
    themeToggleBtn.addEventListener("click", () => {
      const isDark = root.dataset.theme !== "dark";
      setTheme(isDark);
    });

    // --- ê¸°ì¡´ ë¡œì§ (ë‹¨ìœ„: ë‚´ë¶€ëŠ” m, UIëŠ” km) ---
    const MIN_DIST = 1000;
    const MAX_DIST = 20000;
    const MIN_GRAD = 4;
    const MAX_GRAD = 20;

    const catDefs = [
      { label: "CAT4 (D = 8,000)",  D: 8000,  color: "rgba(255,165,0,1)" },
      { label: "CAT3 (D = 16,000)", D: 16000, color: "rgba(54,162,235,1)" },
      { label: "CAT2 (D = 32,000)", D: 32000, color: "rgba(75,192,192,1)" },
      { label: "CAT1 (D = 64,000)", D: 64000, color: "rgba(255,205,86,1)" },
      { label: "HC   (D = 80,000)", D: 80000, color: "rgba(153,102,255,1)" }
    ];

    function createCatDataset(def) {
      const data = [];
      for (let x = MIN_DIST; x <= MAX_DIST; x += 100) {
        const y = def.D / x;
        if (y >= MIN_GRAD && y <= MAX_GRAD) {
          data.push({ x, y });
        }
      }
      return {
        label: def.label,
        data,
        borderColor: def.color,
        backgroundColor: def.color,
        pointRadius: 0,
        borderWidth: 2,
        showLine: true,
        fill: false,
        type: "line"
      };
    }

    const climbsDataset = {
      label: "ì—…í í¬ì¸íŠ¸",
      data: [],                // {x, y, name}
      backgroundColor: "rgba(220,20,60,1)",
      pointRadius: 6,
      showLine: false,
      type: "scatter"
    };

    const ctx = document.getElementById("catChart").getContext("2d");

    // datalabels í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    const datasets = catDefs.map(createCatDataset);
    datasets.push(climbsDataset);

    const catChart = new Chart(ctx, {
      type: "scatter",
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: "top" },
          datalabels: {
            // ì—…í í¬ì¸íŠ¸ì—ë§Œ ë¼ë²¨ í‘œì‹œ
            display: (c) => c.dataset === climbsDataset,
            align: "top",
            anchor: "end",
            offset: 4,
            font: {
              size: 10,
              weight: "600"
            },
            formatter: (value) => value.name || ""
          },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const d = ctx.raw;
                if (!d) return "";
                const distM = d.x;
                const distKm = distM / 1000;
                const grad = d.y;
                if (d.name) {
                  return `${d.name}: ${distKm.toFixed(2)} km, ${grad.toFixed(1)} %`;
                }
                return `ê±°ë¦¬: ${distKm.toFixed(2)} km, ê²½ì‚¬: ${grad.toFixed(1)} %`;
              }
            }
          }
        },
        scales: {
          x: {
            type: "linear",
            min: MIN_DIST,
            max: MAX_DIST,
            title: { display: true, text: "Distance (m)" }
          },
          y: {
            min: MIN_GRAD,
            max: MAX_GRAD,
            title: { display: true, text: "Gradient (%)" }
          }
        }
      }
    });

    function classifyCAT(D) {
      if (D >= 80000) return "HC";
      if (D >= 64000) return "CAT1";
      if (D >= 32000) return "CAT2";
      if (D >= 16000) return "CAT3";
      if (D >= 8000)  return "CAT4";
      return "CAT ë¯¸ë§Œ";
    }

    // ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
    const distanceRange = document.getElementById("distanceRange");
    const gradientRange = document.getElementById("gradientRange");
    const distanceValue = document.getElementById("distanceValue");
    const gradientValue = document.getElementById("gradientValue");

    distanceRange.addEventListener("input", () => {
      distanceValue.textContent = distanceRange.value;
    });

    gradientRange.addEventListener("input", () => {
      gradientValue.textContent = Number(gradientRange.value).toFixed(1);
    });

    // ì—…í ì¶”ê°€ ë²„íŠ¼
    document.getElementById("addClimbBtn").addEventListener("click", () => {
      const distanceKm = Number(distanceRange.value);
      const gradient = Number(gradientRange.value);
      const name = (document.getElementById("name").value.trim() || `Climb ${climbsDataset.data.length + 1}`);

      const distanceM = distanceKm * 1000;
      const D = distanceM * gradient;
      const logValue = Math.log2(D / 8000);
      const cat = classifyCAT(D);

      // ì—¬ëŸ¬ ê°œ ê³„ì† ì¶”ê°€ ê°€ëŠ¥
      climbsDataset.data.push({ x: distanceM, y: gradient, name });
      catChart.update();

      const line =
        `${name} â†’ ê±°ë¦¬: ${distanceKm.toFixed(1)} km, ` +
        `ê²½ì‚¬: ${gradient.toFixed(1)} %, score = ${D.toFixed(0)}, ` +
        `5 - LOG(score/8000,2) = ${(5 - logValue).toFixed(2)}, CAT = ${cat}`;

      const infoDiv = document.getElementById("info");
      infoDiv.textContent = (infoDiv.textContent ? infoDiv.textContent + "\n" : "") + line;

      // ì´ë¦„ ì…ë ¥ì¹¸ì€ ë¹„ì›Œë‘ê³ , ìŠ¬ë¼ì´ë” ê°’ì€ ìœ ì§€
      document.getElementById("name").value = "";
    });
  </script>
</body>
</html>